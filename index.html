<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediConnect</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="static/images/mediconnect_logo_transparent.png">

    <link rel="icon" type="image/x-icon" href="static/images/mediconnect_favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="static/css/base.css">
    
    <style>
        /* Hide install button by default */
        #install-container {
            display: none;
        }
    </style>
</head>

<body class="bg-light d-flex flex-column justify-content-center align-items-center vh-100">
    <div class="card border-0 shadow-lg rounded-4 p-5 text-center bg-white" style="max-width: 400px; width: 90%;">
        
        <div class="mb-4 d-flex justify-content-center">
            <img src="static/images/mediconnect_logo_transparent.png" alt="MediConnect Logo" width="100" height="100" class="me-2" style="object-fit: contain;">
        </div>

        <h1 class="text-primary fw-bold mb-1">MediConnect</h1>
        <p class="text-secondary small mb-4">Hospital Management System</p>

        <div id="install-container" class="mb-4">
            <button id="install-btn" class="btn btn-outline-primary btn-sm rounded-pill px-4">
                <i class="bi bi-download me-2"></i> Install App
            </button>
        </div>

        <div class="d-flex align-items-center justify-content-center gap-2 mb-3">
            <div id="status-spinner" class="spinner-border text-primary spinner-border-sm" role="status"></div>
            <span id="status-text" class="text-secondary small">Establishing secure connection...</span>
        </div>

        <div class="progress bg-secondary bg-opacity-10 rounded-pill" style="height: 6px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary rounded-pill w-100" role="progressbar"></div>
        </div>

        <div class="mt-4 pt-2 border-top">
             <p class="text-muted extra-small mb-0" style="font-size: 12px;">
                <i class="bi bi-shield-lock-fill me-1"></i> SSL Encrypted Connection
            </p>
        </div>

    </div>

    <footer class="mt-5 text-body-secondary small text-center fixed-bottom bg-light border-top py-2">
        <p class="mb-0">
            <i class="bi bi-c-circle"></i> 2025 MediConnect | Made by Debayan
        </p>
    </footer>

    <script>
        const RENDER_BACKEND_URL = "https://active.mediconnect.debz.in/"; 

        // --- PWA Installation Logic ---
        let deferredPrompt;
        const installContainer = document.getElementById('install-container');
        const installBtn = document.getElementById('install-btn');

        // 1. Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }

        // 2. Capture the install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Only show the button if we are in install mode
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'install') {
                installContainer.style.display = 'block';
            }
        });

        // 3. Handle Install Click
        installBtn.addEventListener('click', (e) => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // --- Connection & Redirect Logic ---
        async function checkServerStatus() {
            try {
                await fetch(RENDER_BACKEND_URL, { 
                    method: 'GET',
                    mode: 'no-cors' 
                });
                redirectToApp();
            } catch (error) {
                setTimeout(checkServerStatus, 2000);
            }
        }

        function redirectToApp() {
            const statusText = document.getElementById("status-text");
            const spinner = document.getElementById("status-spinner");
            const progressBar = document.getElementById("progress-bar");
            
            statusText.innerText = "Connected!";
            statusText.classList.replace("text-secondary", "text-success");
            
            spinner.classList.remove("spinner-border", "text-primary");
            spinner.classList.add("bi", "bi-check-circle-fill", "text-success");
            
            progressBar.classList.replace("bg-primary", "bg-success");
            progressBar.classList.remove("progress-bar-striped", "progress-bar-animated");

            window.location.href = RENDER_BACKEND_URL;
        }

        // --- CRITICAL FIX: STOP REDIRECT IF IN INSTALL MODE ---
        const urlParams = new URLSearchParams(window.location.search);
        const isInstallMode = urlParams.get('mode') === 'install';

        if (isInstallMode) {
            // 1. PAUSE REDIRECT: Do NOT call checkServerStatus()
            
            // 2. Update Text
            document.getElementById('status-text').innerText = "Click 'Install App' above";
            document.getElementById('status-spinner').style.display = 'none';
            document.querySelector('.progress').style.display = 'none';

            // 3. Force show the install button container (if prompt captured)
            // Note: The button only works if 'beforeinstallprompt' fired. 
            // If you already installed it, this button might not do anything.
            installContainer.style.display = 'block';
            
            // 4. Add a "Continue" button manually
            const cardBody = document.querySelector('.card');
            
            // Check if continue button already exists to prevent duplicates
            if (!document.getElementById('continue-btn')) {
                const continueBtn = document.createElement('button');
                continueBtn.id = 'continue-btn';
                continueBtn.className = 'btn btn-link text-muted mt-3 text-decoration-none small';
                continueBtn.innerHTML = 'Continue to Website <i class="bi bi-arrow-right"></i>';
                continueBtn.onclick = function() {
                    // Restore loading UI and start checking
                    this.style.display = 'none';
                    installContainer.style.display = 'none'; // Hide install button
                    document.getElementById('status-text').innerText = "Establishing secure connection...";
                    document.getElementById('status-spinner').style.display = 'inline-block';
                    document.querySelector('.progress').style.display = 'flex';
                    checkServerStatus(); // <--- NOW we call it
                };
                cardBody.appendChild(continueBtn);
            }

        } else {
            // NORMAL FLOW: Start checking immediately
            checkServerStatus();
        }
    </script>
</body>
</html>