{% extends "base.html" %}

{% block title %}Book Appointment{% endblock %}

{% block content %}
<h2>Book Appointment</h2>

<form method="get" action="{{ url_for('mediconnect_patient.book_appointment') }}" class="mb-3">
    <div class="row g-3">
        <div class="col-sm-6">
            <input type="text" name="search" id="search" class="form-control" placeholder="Search Doctor" value="{{ request.args.get('search', '') }}">
        </div>
        <div class="col-sm-4">
            <select name="search_by" id="search_by" class="form-select">
                <option value="name" {% if request.args.get('search_by') == 'name' %}selected{% endif %}>Name</option>
                <option value="department" {% if request.args.get('search_by') == 'department' %}selected{% endif %}>Department</option>
            </select>
        </div>
        <div class="col-sm-2">
            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Search</button>
        </div>
    </div>
</form>
<hr>

<h3>Doctors</h3>
<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Department</th>
                <th>Qualification</th>
                <th>Experience (Years)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for doctor in doctors %}
                {% if not request.args.get('search') or
                      request.args.get('search').lower() in doctor.user.full_name.lower() or
                      (doctor.department and request.args.get('search').lower() in doctor.department.name.lower()) %}
                <tr>
                    <td>{{ doctor.user.full_name }}</td>
                    <td>{{ doctor.department.name if doctor.department else 'N/A' }}</td>
                    <td>{{ doctor.qualification }}</td>
                    <td>{{ doctor.experience_years }}</td>
                    <td>
                        <a href="{{ url_for('mediconnect_patient.book_appointment', doctor_id=doctor.doctor_id) }}#slot_id" class="btn btn-primary"><i class="bi bi-calendar2-heart-fill"></i> Book Appointment</a>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
<hr>

{% if selected_doctor_id %}
    <div class="card mt-4">
        <div class="card-body">
            {% if selected_doctor %}
                <h3 class="card-title">Available Slots for {{ selected_doctor.user.full_name }}</h3>
            {% endif %}

            {% if available_slots %}
                <form method="POST">
                    <input type="hidden" name="doctor_id" value="{{ selected_doctor_id }}">
                    <div class="mb-3">
                        <label for="slot_id" class="form-label"><strong>Select a Slot:</strong></label>
                        <select name="slot_id" id="slot_id" class="form-select" required>
                            {% for slot in available_slots %}
                                <option value="{{ slot.slot_id }}">
                                    {{ slot.date }} - {{ slot.time.strftime('%I:%M %p') }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-calendar2-heart-fill"></i> Book Appointment</button>
                    <a href="{{ url_for('mediconnect_patient.book_appointment') }}" class="btn btn-secondary"><i class="bi bi-x-square-fill"></i> Cancel</a>
                </form>
            {% else %}
                <p>No available slots for this doctor.</p>
            {% endif %}
        </div>
    </div>
{% endif %}

<div class="mt-4">
    <a href="{{ url_for('mediconnect_patient.dashboard') }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
</div>
{% endblock %}